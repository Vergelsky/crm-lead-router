# Leads CRM - Система распределения лидов

Мини-CRM для автоматического распределения обращений лидов между операторами по источникам с учётом весов и лимитов нагрузки.

## Основные функции

- **Управление операторами**: создание, просмотр, обновление операторов с настройкой лимитов нагрузки
- **Управление источниками**: создание и настройка источников (ботов)
- **Настройка распределения**: назначение операторов на источники с весами (компетенциями)
- **Автоматическое распределение**: система автоматически выбирает оператора для нового обращения с учётом:
  - Весов операторов по источникам
  - Текущей нагрузки операторов
  - Лимитов максимальной нагрузки
- **Управление лидами**: автоматическое определение и создание лидов
- **Статистика**: просмотр распределения обращений по операторам и источникам

## Технологический стек

- **Python 3.11+**
- **FastAPI** - современный асинхронный веб-фреймворк
- **SQLAlchemy (async)** - асинхронный ORM
- **Alembic** - миграции базы данных
- **SQLite** - база данных
- **Docker** - контейнеризация

## Архитектура

Приложение построено с использованием принципов:
- **Hexagonal Architecture** - разделение на слои (domain, infrastructure, api)
- **Modular Monolith** - модульная структура с чёткими границами
- **Clean Architecture** - разделение бизнес-логики и инфраструктуры

### Структура проекта

```
app/
├── api/              # Слой API (FastAPI роуты)
│   ├── operators.py  # Управление операторами
│   ├── sources.py    # Управление источниками
│   ├── contacts.py   # Регистрация обращений
│   ├── leads.py      # Просмотр лидов
│   └── schemas.py    # Pydantic схемы
├── domain/           # Доменные модели
│   └── models.py     # SQLAlchemy модели
├── infrastructure/   # Инфраструктурный слой
│   └── repositories.py  # Репозитории для работы с БД
├── services/         # Бизнес-логика
│   └── distribution_service.py  # Логика распределения
└── core/             # Ядро приложения
    ├── config.py     # Настройки
    └── database.py   # Подключение к БД
```

## Быстрый старт

```bash
# Запустить приложение и базу данных
docker-compose up -d

# Применить миграции
docker-compose exec app alembic upgrade head

# Приложение будет доступно по адресу http://localhost:8000
# Документация API: http://localhost:8000/docs
```

При запуске создаются два контейнера:
- **db** - контейнер для хранения базы данных SQLite (данные хранятся в Docker volume)
- **app** - контейнер с приложением FastAPI

## Модель данных

### Оператор (Operator)
- `id` - уникальный идентификатор
- `name` - имя оператора
- `is_active` - активен ли оператор (может получать новые обращения)
- `max_load` - лимит максимального количества активных обращений

### Источник (Source)
- `id` - уникальный идентификатор
- `name` - название источника (бота)
- `description` - описание

### Вес оператора по источнику (OperatorSourceWeight)
- `operator_id` - идентификатор оператора
- `source_id` - идентификатор источника
- `weight` - числовой вес (компетенция) для распределения

### Лид (Lead)
- `id` - уникальный идентификатор
- `external_id` - внешний идентификатор (опционально)
- `phone` - телефон (опционально)
- `email` - email (опционально)
- `name` - имя лида (опционально)

### Обращение (Contact)
- `id` - уникальный идентификатор
- `lead_id` - идентификатор лида
- `source_id` - идентификатор источника
- `operator_id` - идентификатор назначенного оператора (может быть NULL)
- `status` - статус обращения (active, closed и т.д.)
- `message` - дополнительная информация об обращении

## Алгоритм распределения

### Определение лида

Система определяет, что обращения принадлежат одному и тому же лиду, по следующим полям:
- `external_id` - внешний идентификатор (приоритетный)
- `phone` - номер телефона
- `email` - адрес электронной почты

Если лид с такими данными уже существует, обращение связывается с ним. Если нет - создаётся новый лид.

### Выбор оператора

При создании нового обращения система:

1. **Определяет доступных операторов**:
   - Операторы, назначенные на данный источник
   - Операторы активны (`is_active = True`)
   - Текущая нагрузка оператора меньше лимита (`current_load < max_load`)

2. **Распределяет с учётом весов**:
   - Используется вероятностный алгоритм на основе весов
   - Вероятность выбора оператора = `вес_оператора / сумма_всех_весов`
   - Пример: оператор1 с весом 10, оператор2 с весом 30 → 25% и 75% трафика соответственно

3. **Создаёт обращение**:
   - Если подходящий оператор найден - обращение назначается ему
   - Если подходящих операторов нет - обращение создаётся без оператора (`operator_id = NULL`)

### Учёт лимитов нагрузки

Нагрузка оператора определяется как количество активных обращений (`status = 'active'`). Если оператор достиг лимита (`current_load >= max_load`), он исключается из списка доступных операторов для новых обращений.

## API Эндпоинты

### Операторы
- `POST /api/v1/operators` - создать оператора
- `GET /api/v1/operators` - список операторов
- `GET /api/v1/operators/{id}` - получить оператора
- `PATCH /api/v1/operators/{id}` - обновить оператора

### Источники
- `POST /api/v1/sources` - создать источник
- `GET /api/v1/sources` - список источников
- `GET /api/v1/sources/{id}` - получить источник
- `PATCH /api/v1/sources/{id}` - обновить источник
- `POST /api/v1/sources/{id}/distribution` - настроить распределение
- `GET /api/v1/sources/{id}/distribution` - получить конфигурацию распределения

### Обращения
- `POST /api/v1/contacts` - зарегистрировать обращение (автоматическое распределение)
- `GET /api/v1/contacts` - список обращений
- `GET /api/v1/contacts/{id}` - получить обращение
- `GET /api/v1/contacts/stats/distribution` - статистика распределения

### Лиды
- `GET /api/v1/leads` - список лидов с обращениями
- `GET /api/v1/leads/{id}` - получить лида с обращениями

Полная документация API доступна по адресу `/docs` после запуска приложения.

## Примеры использования

### Создание оператора
```bash
curl -X POST "http://localhost:8000/api/v1/operators" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Иван Иванов",
    "is_active": true,
    "max_load": 15
  }'
```

### Создание источника
```bash
curl -X POST "http://localhost:8000/api/v1/sources" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Telegram Bot #1",
    "description": "Основной бот"
  }'
```

### Настройка распределения
```bash
curl -X POST "http://localhost:8000/api/v1/sources/1/distribution" \
  -H "Content-Type: application/json" \
  -d '{
    "operator_weights": [
      {"operator_id": 1, "source_id": 1, "weight": 10},
      {"operator_id": 2, "source_id": 1, "weight": 30}
    ]
  }'
```

### Регистрация обращения
```bash
curl -X POST "http://localhost:8000/api/v1/contacts" \
  -H "Content-Type: application/json" \
  -d '{
    "source_id": 1,
    "lead_phone": "+79001234567",
    "lead_name": "Петр Петров",
    "message": "Хочу узнать о продукте"
  }'
```

## Тестирование

### Запуск тестов

Все тесты запускаются в Docker контейнере:

```bash
# Запустить все тесты
docker-compose exec app pytest

# Запустить тесты с подробным выводом
docker-compose exec app pytest -v

# Запустить конкретный тестовый файл
docker-compose exec app pytest tests/test_operators.py

# Запустить конкретный тест
docker-compose exec app pytest tests/test_operators.py::test_create_operator

# Запустить тесты с покрытием (если установлен pytest-cov)
docker-compose exec app pytest --cov=app
```

### Структура тестов

Тесты находятся в директории `tests/`:
- `test_operators.py` - тесты для управления операторами
- `test_sources.py` - тесты для управления источниками и распределением
- `test_contacts.py` - тесты для регистрации обращений
- `test_leads.py` - тесты для работы с лидами

Все тесты используют in-memory SQLite базу данных, которая создаётся для каждого теста.

## Дополнительная документация

Подробная документация для разработчиков находится в файле [docs/DEVELOPMENT.md](docs/DEVELOPMENT.md).

